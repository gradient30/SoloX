# å¼€å‘æŒ‡å—

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒæ­å»º

### 1. å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/smart-test-ti/SoloX.git
cd SoloX
```

### 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
# Windows
venv\Scripts\activate
# macOS/Linux
source venv/bin/activate
```

### 3. å®‰è£…å¼€å‘ä¾èµ–

```bash
# å®‰è£…é¡¹ç›®ä¾èµ–
pip install -r requirements.txt

# å®‰è£…å¼€å‘å·¥å…· (å¯é€‰)
pip install pytest pytest-cov black flake8 mypy
```

### 4. é…ç½®å¼€å‘ç¯å¢ƒ

```bash
# è®¾ç½® PYTHONPATH
export PYTHONPATH=$PYTHONPATH:$(pwd)

# æˆ–åœ¨ IDE ä¸­é…ç½®é¡¹ç›®æ ¹ç›®å½•ä¸ºæºç ç›®å½•
```

## ğŸ“ é¡¹ç›®ç»“æ„è¯¦è§£

```
solox/
â”œâ”€â”€ __init__.py              # åŒ…åˆå§‹åŒ–å’Œç‰ˆæœ¬ä¿¡æ¯
â”œâ”€â”€ __main__.py              # å‘½ä»¤è¡Œå…¥å£ç‚¹
â”œâ”€â”€ web.py                   # ç”Ÿäº§ç¯å¢ƒ Web æœåŠ¡
â”œâ”€â”€ debug.py                 # å¼€å‘è°ƒè¯• Web æœåŠ¡
â”œâ”€â”€ public/                  # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ apm.py              # æ€§èƒ½ç›‘æ§æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ apm_pk.py           # å¯¹æ¯”æµ‹è¯•æ¨¡å—
â”‚   â”œâ”€â”€ common.py           # å…¬å…±å·¥å…·å’Œè®¾å¤‡ç®¡ç†
â”‚   â””â”€â”€ scrcpy/             # å±å¹•å½•åˆ¶å·¥å…·
â”œâ”€â”€ view/                    # Web è§†å›¾å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ apis.py             # RESTful API è·¯ç”±
â”‚   â””â”€â”€ pages.py            # Web é¡µé¢è·¯ç”±
â”œâ”€â”€ templates/               # Jinja2 HTML æ¨¡æ¿
â”‚   â”œâ”€â”€ index.html          # ä¸»é¡µé¢
â”‚   â”œâ”€â”€ 404.html            # 404 é”™è¯¯é¡µ
â”‚   â””â”€â”€ 500.html            # 500 é”™è¯¯é¡µ
â”œâ”€â”€ static/                  # é™æ€èµ„æº
â”‚   â”œâ”€â”€ css/                # æ ·å¼æ–‡ä»¶
â”‚   â”œâ”€â”€ js/                 # JavaScript æ–‡ä»¶
â”‚   â””â”€â”€ images/             # å›¾ç‰‡èµ„æº
â””â”€â”€ __pycache__/            # Python å­—èŠ‚ç ç¼“å­˜
```

## ğŸ”§ å¼€å‘æ¨¡å¼å¯åŠ¨

### è°ƒè¯•æ¨¡å¼

```bash
# è¿›å…¥ solox ç›®å½•
cd solox

# å¯åŠ¨è°ƒè¯•æœåŠ¡ (è‡ªåŠ¨é‡è½½)
python debug.py

# æˆ–æŒ‡å®šå‚æ•°
python debug.py --host=0.0.0.0 --port=5000
```

### ç”Ÿäº§æ¨¡å¼

```bash
# ä½¿ç”¨ç”Ÿäº§é…ç½®å¯åŠ¨
python -m solox

# æˆ–ç›´æ¥è¿è¡Œ web.py
python solox/web.py
```

## ğŸ—ï¸ æ ¸å¿ƒæ¨¡å—å¼€å‘

### 1. APM æ¨¡å—æ‰©å±•

åœ¨ `solox/public/apm.py` ä¸­æ·»åŠ æ–°çš„æ€§èƒ½ç›‘æ§åŠŸèƒ½:

```python
class AppPerformanceMonitor:
    
    def collectCustomMetric(self, noLog=False):
        """è‡ªå®šä¹‰æ€§èƒ½æŒ‡æ ‡æ”¶é›†"""
        try:
            # å®ç°è‡ªå®šä¹‰ç›‘æ§é€»è¾‘
            metric_value = self._getCustomMetric()
            
            if noLog is False:
                apm_time = datetime.datetime.now().strftime('%H:%M:%S.%f')
                f.add_log(os.path.join(f.report_dir, 'custom.log'), 
                         apm_time, metric_value)
            
            return metric_value
        except Exception as e:
            logger.exception(e)
            return 0
    
    def _getCustomMetric(self):
        """è·å–è‡ªå®šä¹‰æŒ‡æ ‡çš„å…·ä½“å®ç°"""
        # æ ¹æ®å¹³å°å®ç°ä¸åŒçš„è·å–é€»è¾‘
        if self.platform == Platform.Android:
            return self._getAndroidCustomMetric()
        elif self.platform == Platform.iOS:
            return self._getiOSCustomMetric()
        else:
            raise Exception(f"Unsupported platform: {self.platform}")
```

### 2. API æ¥å£æ‰©å±•

åœ¨ `solox/view/apis.py` ä¸­æ·»åŠ æ–°çš„ API ç«¯ç‚¹:

```python
@api.route('/apm/custom', methods=['GET', 'POST'])
def custom_metric():
    """è‡ªå®šä¹‰æ€§èƒ½æŒ‡æ ‡ API"""
    try:
        # è·å–è¯·æ±‚å‚æ•°
        platform = request.args.get('platform', 'Android')
        deviceid = request.args.get('deviceid')
        pkgname = request.args.get('pkgname')
        
        # å‚æ•°éªŒè¯
        if not all([deviceid, pkgname]):
            return make_response({'code': 400, 'msg': 'Missing parameters'})
        
        # åˆ›å»ºç›‘æ§å®ä¾‹
        apm = AppPerformanceMonitor(
            pkgName=pkgname,
            platform=platform,
            deviceId=deviceid,
            noLog=True
        )
        
        # æ”¶é›†æ•°æ®
        metric_data = apm.collectCustomMetric()
        
        return make_response({
            'code': 200,
            'msg': 'success',
            'data': {
                'custom_metric': metric_data,
                'timestamp': time.time()
            }
        })
        
    except Exception as e:
        logger.exception(e)
        return make_response({'code': 500, 'msg': str(e)})
```

### 3. è®¾å¤‡ç®¡ç†æ‰©å±•

åœ¨ `solox/public/common.py` ä¸­æ‰©å±•è®¾å¤‡ç®¡ç†åŠŸèƒ½:

```python
class Devices:
    
    def getDeviceInfo(self, deviceId):
        """è·å–è®¾å¤‡è¯¦ç»†ä¿¡æ¯"""
        try:
            if self.platform == Platform.Android:
                return self._getAndroidDeviceInfo(deviceId)
            elif self.platform == Platform.iOS:
                return self._getiOSDeviceInfo(deviceId)
        except Exception as e:
            logger.exception(e)
            return {}
    
    def _getAndroidDeviceInfo(self, deviceId):
        """è·å– Android è®¾å¤‡ä¿¡æ¯"""
        info = {}
        
        # è®¾å¤‡å‹å·
        model = self.execCmd(f'{self.adb} -s {deviceId} shell getprop ro.product.model')
        info['model'] = model.strip()
        
        # Android ç‰ˆæœ¬
        version = self.execCmd(f'{self.adb} -s {deviceId} shell getprop ro.build.version.release')
        info['android_version'] = version.strip()
        
        # CPU æ¶æ„
        abi = self.execCmd(f'{self.adb} -s {deviceId} shell getprop ro.product.cpu.abi')
        info['cpu_abi'] = abi.strip()
        
        # å±å¹•åˆ†è¾¨ç‡
        resolution = self.execCmd(f'{self.adb} -s {deviceId} shell wm size')
        info['resolution'] = resolution.strip()
        
        return info
```

## ğŸ¨ å‰ç«¯å¼€å‘

### 1. é¡µé¢æ¨¡æ¿å¼€å‘

åœ¨ `solox/templates/` ä¸­åˆ›å»ºæ–°çš„é¡µé¢æ¨¡æ¿:

```html
<!-- custom_monitor.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Monitor - SoloX</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tabler.min.css') }}">
</head>
<body>
    <div class="page">
        <div class="page-wrapper">
            <div class="container-xl">
                <div class="page-header">
                    <h1 class="page-title">è‡ªå®šä¹‰ç›‘æ§</h1>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <canvas id="customChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/custom-monitor.js') }}"></script>
</body>
</html>
```

### 2. JavaScript å¼€å‘

åœ¨ `solox/static/js/` ä¸­åˆ›å»ºå¯¹åº”çš„ JavaScript æ–‡ä»¶:

```javascript
// custom-monitor.js
class CustomMonitor {
    constructor() {
        this.chart = null;
        this.data = [];
        this.init();
    }
    
    init() {
        this.initChart();
        this.startMonitoring();
    }
    
    initChart() {
        const ctx = document.getElementById('customChart').getContext('2d');
        this.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Custom Metric',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    startMonitoring() {
        setInterval(() => {
            this.fetchData();
        }, 1000);
    }
    
    async fetchData() {
        try {
            const response = await fetch('/apm/custom?platform=Android&deviceid=xxx&pkgname=xxx');
            const result = await response.json();
            
            if (result.code === 200) {
                this.updateChart(result.data);
            }
        } catch (error) {
            console.error('Failed to fetch data:', error);
        }
    }
    
    updateChart(data) {
        const now = new Date().toLocaleTimeString();
        
        this.chart.data.labels.push(now);
        this.chart.data.datasets[0].data.push(data.custom_metric);
        
        // ä¿æŒæœ€è¿‘ 20 ä¸ªæ•°æ®ç‚¹
        if (this.chart.data.labels.length > 20) {
            this.chart.data.labels.shift();
            this.chart.data.datasets[0].data.shift();
        }
        
        this.chart.update();
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    new CustomMonitor();
});
```

## ğŸ§ª æµ‹è¯•å¼€å‘

### 1. å•å…ƒæµ‹è¯•

åˆ›å»º `tests/` ç›®å½•å¹¶æ·»åŠ æµ‹è¯•æ–‡ä»¶:

```python
# tests/test_apm.py
import unittest
from unittest.mock import patch, MagicMock
from solox.public.apm import AppPerformanceMonitor
from solox.public.common import Platform

class TestAppPerformanceMonitor(unittest.TestCase):
    
    def setUp(self):
        self.apm = AppPerformanceMonitor(
            pkgName='com.test.app',
            platform=Platform.Android,
            deviceId='test_device',
            noLog=True
        )
    
    @patch('solox.public.apm.AppPerformanceMonitor.getAndroidCpuRate')
    def test_collect_cpu(self, mock_cpu):
        # æ¨¡æ‹Ÿ CPU æ•°æ®
        mock_cpu.return_value = (50.5, 25.3)
        
        app_cpu, sys_cpu = self.apm.collectCpu()
        
        self.assertEqual(app_cpu, 50.5)
        self.assertEqual(sys_cpu, 25.3)
        mock_cpu.assert_called_once()
    
    @patch('solox.public.apm.AppPerformanceMonitor.getAndroidMem')
    def test_collect_memory(self, mock_memory):
        # æ¨¡æ‹Ÿå†…å­˜æ•°æ®
        mock_memory.return_value = (512, 1024, 2048)
        
        pss, private, total = self.apm.collectMemory()
        
        self.assertEqual(pss, 512)
        self.assertEqual(private, 1024)
        self.assertEqual(total, 2048)
        mock_memory.assert_called_once()

if __name__ == '__main__':
    unittest.main()
```

### 2. é›†æˆæµ‹è¯•

```python
# tests/test_integration.py
import unittest
import requests
import time
from solox.web import main
import multiprocessing

class TestIntegration(unittest.TestCase):
    
    @classmethod
    def setUpClass(cls):
        # å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨
        cls.server_process = multiprocessing.Process(
            target=main, 
            args=('127.0.0.1', 50004)
        )
        cls.server_process.start()
        time.sleep(2)  # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
        
        cls.base_url = 'http://127.0.0.1:50004'
    
    @classmethod
    def tearDownClass(cls):
        cls.server_process.terminate()
        cls.server_process.join()
    
    def test_health_check(self):
        response = requests.get(f'{self.base_url}/health')
        self.assertEqual(response.status_code, 200)
    
    def test_api_collect(self):
        url = f'{self.base_url}/apm/collect'
        params = {
            'platform': 'Android',
            'deviceid': 'test_device',
            'pkgname': 'com.test.app',
            'target': 'cpu'
        }
        
        response = requests.get(url, params=params)
        self.assertEqual(response.status_code, 200)
        
        data = response.json()
        self.assertIn('code', data)
        self.assertIn('data', data)

if __name__ == '__main__':
    unittest.main()
```

### 3. è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python -m pytest tests/

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
python -m pytest tests/test_apm.py

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
python -m pytest tests/ --cov=solox --cov-report=html
```

## ğŸ“ ä»£ç è§„èŒƒ

### 1. Python ä»£ç é£æ ¼

ä½¿ç”¨ Black è¿›è¡Œä»£ç æ ¼å¼åŒ–:

```bash
# æ ¼å¼åŒ–ä»£ç 
black solox/

# æ£€æŸ¥ä»£ç é£æ ¼
flake8 solox/

# ç±»å‹æ£€æŸ¥
mypy solox/
```

### 2. æäº¤è§„èŒƒ

```bash
# æäº¤ä¿¡æ¯æ ¼å¼
git commit -m "feat: æ·»åŠ è‡ªå®šä¹‰æ€§èƒ½ç›‘æ§åŠŸèƒ½"
git commit -m "fix: ä¿®å¤ iOS è®¾å¤‡è¿æ¥é—®é¢˜"
git commit -m "docs: æ›´æ–° API æ–‡æ¡£"
git commit -m "test: æ·»åŠ  APM æ¨¡å—å•å…ƒæµ‹è¯•"
```

### 3. åˆ†æ”¯ç®¡ç†

```bash
# åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/custom-monitoring

# åˆ›å»ºä¿®å¤åˆ†æ”¯
git checkout -b fix/ios-connection

# åˆå¹¶åˆ°ä¸»åˆ†æ”¯
git checkout main
git merge feature/custom-monitoring
```

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æ—¥å¿—è°ƒè¯•

```python
from logzero import logger

# æ·»åŠ è°ƒè¯•æ—¥å¿—
logger.debug("Debug information")
logger.info("Information message")
logger.warning("Warning message")
logger.error("Error message")
logger.exception("Exception with traceback")
```

### 2. æ–­ç‚¹è°ƒè¯•

```python
# ä½¿ç”¨ pdb è°ƒè¯•
import pdb
pdb.set_trace()

# æˆ–ä½¿ç”¨ IDE æ–­ç‚¹è°ƒè¯•
```

### 3. æ€§èƒ½åˆ†æ

```python
import cProfile
import pstats

# æ€§èƒ½åˆ†æ
profiler = cProfile.Profile()
profiler.enable()

# æ‰§è¡Œä»£ç 
your_function()

profiler.disable()
stats = pstats.Stats(profiler)
stats.sort_stats('cumulative')
stats.print_stats()
```

---

*ä¸‹ä¸€æ­¥: [APIæ–‡æ¡£](./05-APIæ–‡æ¡£.md)*
