# éƒ¨ç½²æŒ‡å—

## ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### 1. æœåŠ¡å™¨è¦æ±‚

**ç¡¬ä»¶è¦æ±‚**:
- CPU: 2 æ ¸å¿ƒä»¥ä¸Š
- å†…å­˜: 4GB ä»¥ä¸Š
- å­˜å‚¨: 20GB ä»¥ä¸Šå¯ç”¨ç©ºé—´
- ç½‘ç»œ: ç¨³å®šçš„ç½‘ç»œè¿æ¥

**è½¯ä»¶è¦æ±‚**:
- æ“ä½œç³»ç»Ÿ: Ubuntu 18.04+, CentOS 7+, Windows Server 2019+
- Python: 3.10+
- ADB: æœ€æ–°ç‰ˆæœ¬
- é˜²ç«å¢™: å¼€æ”¾æœåŠ¡ç«¯å£

### 2. ç¯å¢ƒå‡†å¤‡

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3.10 python3.10-pip python3.10-venv
sudo apt install android-tools-adb

# CentOS/RHEL
sudo yum install python3 python3-pip
# æ‰‹åŠ¨å®‰è£… ADB

# åˆ›å»ºæœåŠ¡ç”¨æˆ·
sudo useradd -m -s /bin/bash solox
sudo su - solox
```

### 3. åº”ç”¨éƒ¨ç½²

```bash
# åˆ›å»ºåº”ç”¨ç›®å½•
mkdir -p /opt/solox
cd /opt/solox

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate

# å®‰è£… SoloX
pip install -U solox

# æˆ–ä»æºç å®‰è£…
git clone https://github.com/smart-test-ti/SoloX.git
cd SoloX
pip install -e .
```

## ğŸ³ Docker éƒ¨ç½²

### 1. Dockerfile

```dockerfile
FROM python:3.10-slim

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    android-tools-adb \
    wget \
    unzip \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºåº”ç”¨ç›®å½•
WORKDIR /app

# å¤åˆ¶åº”ç”¨æ–‡ä»¶
COPY . .

# å®‰è£… Python ä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p /app/data /app/logs

# æš´éœ²ç«¯å£
EXPOSE 50003

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app
ENV SOLOX_HOST=0.0.0.0
ENV SOLOX_PORT=50003

# å¯åŠ¨å‘½ä»¤
CMD ["python", "-m", "solox", "--host=0.0.0.0", "--port=50003"]
```

### 2. Docker Compose

```yaml
# docker-compose.yml
version: '3.8'

services:
  solox:
    build: .
    ports:
      - "50003:50003"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - /dev/bus/usb:/dev/bus/usb  # USB è®¾å¤‡è®¿é—®
    devices:
      - /dev/bus/usb  # USB è®¾å¤‡æƒé™
    privileged: true  # éœ€è¦è®¾å¤‡è®¿é—®æƒé™
    environment:
      - SOLOX_HOST=0.0.0.0
      - SOLOX_PORT=50003
    restart: unless-stopped
    
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - solox
    restart: unless-stopped
```

### 3. æ„å»ºå’Œè¿è¡Œ

```bash
# æ„å»ºé•œåƒ
docker build -t solox:latest .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name solox \
  -p 50003:50003 \
  -v $(pwd)/data:/app/data \
  -v /dev/bus/usb:/dev/bus/usb \
  --privileged \
  solox:latest

# ä½¿ç”¨ Docker Compose
docker-compose up -d
```

## âš™ï¸ ç³»ç»ŸæœåŠ¡é…ç½®

### 1. Systemd æœåŠ¡ (Linux)

```ini
# /etc/systemd/system/solox.service
[Unit]
Description=SoloX Performance Monitor
After=network.target

[Service]
Type=simple
User=solox
Group=solox
WorkingDirectory=/opt/solox
Environment=PATH=/opt/solox/venv/bin
ExecStart=/opt/solox/venv/bin/python -m solox --host=0.0.0.0 --port=50003
Restart=always
RestartSec=10

# æ—¥å¿—é…ç½®
StandardOutput=journal
StandardError=journal
SyslogIdentifier=solox

# å®‰å…¨é…ç½®
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/solox/data /opt/solox/logs

[Install]
WantedBy=multi-user.target
```

```bash
# å¯ç”¨å’Œå¯åŠ¨æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl enable solox
sudo systemctl start solox

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status solox

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u solox -f
```

### 2. Windows æœåŠ¡

```python
# solox_service.py
import win32serviceutil
import win32service
import win32event
import servicemanager
import socket
import sys
import os
from solox.web import main

class SoloXService(win32serviceutil.ServiceFramework):
    _svc_name_ = "SoloXService"
    _svc_display_name_ = "SoloX Performance Monitor"
    _svc_description_ = "SoloX mobile performance monitoring service"

    def __init__(self, args):
        win32serviceutil.ServiceFramework.__init__(self, args)
        self.hWaitStop = win32event.CreateEvent(None, 0, 0, None)
        socket.setdefaulttimeout(60)

    def SvcStop(self):
        self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)
        win32event.SetEvent(self.hWaitStop)

    def SvcDoRun(self):
        servicemanager.LogMsg(servicemanager.EVENTLOG_INFORMATION_TYPE,
                              servicemanager.PYS_SERVICE_STARTED,
                              (self._svc_name_, ''))
        self.main()

    def main(self):
        # å¯åŠ¨ SoloX æœåŠ¡
        main(host='0.0.0.0', port=50003)

if __name__ == '__main__':
    win32serviceutil.HandleCommandLine(SoloXService)
```

```cmd
# å®‰è£…æœåŠ¡
python solox_service.py install

# å¯åŠ¨æœåŠ¡
python solox_service.py start

# åœæ­¢æœåŠ¡
python solox_service.py stop

# å¸è½½æœåŠ¡
python solox_service.py remove
```

## ğŸ”’ å®‰å…¨é…ç½®

### 1. é˜²ç«å¢™é…ç½®

```bash
# Ubuntu/Debian (UFW)
sudo ufw allow 50003/tcp
sudo ufw enable

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=50003/tcp
sudo firewall-cmd --reload

# Windows
netsh advfirewall firewall add rule name="SoloX" dir=in action=allow protocol=TCP localport=50003
```

### 2. SSL/TLS é…ç½®

```nginx
# nginx.conf
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;

    location / {
        proxy_pass http://127.0.0.1:50003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket æ”¯æŒ
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

### 3. è®¿é—®æ§åˆ¶

```python
# åœ¨ solox/web.py ä¸­æ·»åŠ è®¤è¯ä¸­é—´ä»¶
from functools import wraps
from flask import request, abort

def require_auth(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        auth_token = request.headers.get('Authorization')
        if not auth_token or not validate_token(auth_token):
            abort(401)
        return f(*args, **kwargs)
    return decorated_function

def validate_token(token):
    # å®ç° token éªŒè¯é€»è¾‘
    return token == "your-secret-token"

# åœ¨ API è·¯ç”±ä¸­ä½¿ç”¨
@api.route('/apm/collect')
@require_auth
def collect_performance():
    # API å®ç°
    pass
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. åº”ç”¨ç›‘æ§

```python
# å¥åº·æ£€æŸ¥ç«¯ç‚¹
@app.route('/health')
def health_check():
    return {
        'status': 'ok',
        'timestamp': time.time(),
        'version': __version__,
        'uptime': time.time() - start_time
    }

# æŒ‡æ ‡ç«¯ç‚¹
@app.route('/metrics')
def metrics():
    return {
        'active_connections': get_active_connections(),
        'total_requests': get_total_requests(),
        'memory_usage': get_memory_usage(),
        'cpu_usage': get_cpu_usage()
    }
```

### 2. æ—¥å¿—é…ç½®

```python
# æ—¥å¿—é…ç½®
import logging
from logging.handlers import RotatingFileHandler

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s %(levelname)s %(name)s %(message)s'
)

# æ–‡ä»¶æ—¥å¿—
file_handler = RotatingFileHandler(
    '/opt/solox/logs/solox.log',
    maxBytes=10*1024*1024,  # 10MB
    backupCount=5
)
file_handler.setFormatter(logging.Formatter(
    '%(asctime)s %(levelname)s %(name)s %(message)s'
))

app.logger.addHandler(file_handler)
```

### 3. å¤–éƒ¨ç›‘æ§é›†æˆ

```yaml
# Prometheus ç›‘æ§é…ç½®
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'solox'
    static_configs:
      - targets: ['localhost:50003']
    metrics_path: '/metrics'
    scrape_interval: 30s
```

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–

### 1. åº”ç”¨ä¼˜åŒ–

```python
# è¿æ¥æ± é…ç½®
from flask import Flask
from werkzeug.serving import WSGIRequestHandler

class CustomRequestHandler(WSGIRequestHandler):
    def setup(self):
        super().setup()
        # è®¾ç½® TCP_NODELAY
        self.connection.setsockopt(socket.IPPROTO_TCP, socket.TCP_NODELAY, 1)

# å¯åŠ¨é…ç½®
app.run(
    host='0.0.0.0',
    port=50003,
    threaded=True,
    request_handler=CustomRequestHandler
)
```

### 2. æ•°æ®åº“ä¼˜åŒ–

```python
# ä½¿ç”¨ Redis ç¼“å­˜
import redis

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def cache_performance_data(device_id, data):
    key = f"perf:{device_id}:{int(time.time())}"
    redis_client.setex(key, 3600, json.dumps(data))  # 1å°æ—¶è¿‡æœŸ

def get_cached_data(device_id, start_time, end_time):
    pattern = f"perf:{device_id}:*"
    keys = redis_client.keys(pattern)
    # è¿‡æ»¤æ—¶é—´èŒƒå›´å†…çš„æ•°æ®
    return [json.loads(redis_client.get(key)) for key in keys]
```

### 3. è´Ÿè½½å‡è¡¡

```nginx
# nginx è´Ÿè½½å‡è¡¡é…ç½®
upstream solox_backend {
    server 127.0.0.1:50003;
    server 127.0.0.1:50004;
    server 127.0.0.1:50005;
}

server {
    listen 80;
    location / {
        proxy_pass http://solox_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## ğŸ”„ å¤‡ä»½å’Œæ¢å¤

### 1. æ•°æ®å¤‡ä»½

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/opt/solox/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="solox_backup_${DATE}.tar.gz"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®
tar -czf $BACKUP_DIR/$BACKUP_FILE \
    /opt/solox/data \
    /opt/solox/logs \
    /opt/solox/config

# æ¸…ç†æ—§å¤‡ä»½ (ä¿ç•™æœ€è¿‘ 7 å¤©)
find $BACKUP_DIR -name "solox_backup_*.tar.gz" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR/$BACKUP_FILE"
```

### 2. è‡ªåŠ¨å¤‡ä»½

```bash
# æ·»åŠ åˆ° crontab
crontab -e

# æ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½
0 2 * * * /opt/solox/scripts/backup.sh
```

### 3. æ¢å¤æµç¨‹

```bash
#!/bin/bash
# restore.sh

BACKUP_FILE=$1

if [ -z "$BACKUP_FILE" ]; then
    echo "ç”¨æ³•: $0 <backup_file>"
    exit 1
fi

# åœæ­¢æœåŠ¡
sudo systemctl stop solox

# æ¢å¤æ•°æ®
tar -xzf $BACKUP_FILE -C /

# å¯åŠ¨æœåŠ¡
sudo systemctl start solox

echo "æ¢å¤å®Œæˆ"
```

## ğŸ“ˆ æ‰©å±•éƒ¨ç½²

### 1. é›†ç¾¤éƒ¨ç½²

```yaml
# kubernetes éƒ¨ç½²
apiVersion: apps/v1
kind: Deployment
metadata:
  name: solox
spec:
  replicas: 3
  selector:
    matchLabels:
      app: solox
  template:
    metadata:
      labels:
        app: solox
    spec:
      containers:
      - name: solox
        image: solox:latest
        ports:
        - containerPort: 50003
        env:
        - name: SOLOX_HOST
          value: "0.0.0.0"
        - name: SOLOX_PORT
          value: "50003"
---
apiVersion: v1
kind: Service
metadata:
  name: solox-service
spec:
  selector:
    app: solox
  ports:
  - port: 80
    targetPort: 50003
  type: LoadBalancer
```

### 2. å¾®æœåŠ¡æ¶æ„

```python
# æ‹†åˆ†ä¸ºå¤šä¸ªå¾®æœåŠ¡
# 1. API ç½‘å…³æœåŠ¡
# 2. è®¾å¤‡ç®¡ç†æœåŠ¡
# 3. æ•°æ®æ”¶é›†æœåŠ¡
# 4. æ•°æ®åˆ†ææœåŠ¡
# 5. æŠ¥å‘Šç”ŸæˆæœåŠ¡
```

---

*ä¸‹ä¸€æ­¥: [æ•…éšœæ’é™¤](./08-æ•…éšœæ’é™¤.md)*
