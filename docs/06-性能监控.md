# æ€§èƒ½ç›‘æ§è¯¦è§£

## ğŸ¯ ç›‘æ§æŒ‡æ ‡æ¦‚è¿°

SoloX æä¾›å…¨é¢çš„ç§»åŠ¨åº”ç”¨æ€§èƒ½ç›‘æ§ï¼Œæ¶µç›– CPUã€å†…å­˜ã€ç½‘ç»œã€æ¸²æŸ“ã€ç”µæ± ç­‰å…³é”®æŒ‡æ ‡ã€‚

## ğŸ“Š CPU ç›‘æ§

### ç›‘æ§åŸç†

**Android**:
- é€šè¿‡ `/proc/stat` å’Œ `/proc/{pid}/stat` è·å– CPU ä½¿ç”¨ç‡
- è®¡ç®—åº”ç”¨è¿›ç¨‹å’Œç³»ç»Ÿæ•´ä½“çš„ CPU å ç”¨

**iOS**:
- ä½¿ç”¨ `tidevice` å·¥å…·è·å–åº”ç”¨ CPU ä½¿ç”¨ç‡
- é€šè¿‡ç³»ç»Ÿ API è·å–ç²¾ç¡®çš„ CPU æ•°æ®

### æ•°æ®æ ¼å¼

```json
{
  "appCpuRate": 25.5,    // åº”ç”¨ CPU ä½¿ç”¨ç‡ (%)
  "systemCpuRate": 45.2  // ç³»ç»Ÿ CPU ä½¿ç”¨ç‡ (%)
}
```

### ä½¿ç”¨ç¤ºä¾‹

```python
# Python API
app_cpu, sys_cpu = apm.collectCpu()
print(f"åº”ç”¨ CPU: {app_cpu}%, ç³»ç»Ÿ CPU: {sys_cpu}%")

# HTTP API
curl "http://localhost:50003/apm/collect?platform=Android&deviceid=ca6bd5a5&pkgname=com.example.app&target=cpu"
```

### æ€§èƒ½åˆ†æ

- **æ­£å¸¸èŒƒå›´**: åº”ç”¨ CPU < 30%ï¼Œç³»ç»Ÿ CPU < 70%
- **æ€§èƒ½é—®é¢˜**: æŒç»­é«˜ CPU ä½¿ç”¨ç‡å¯èƒ½å¯¼è‡´å‘çƒ­å’Œè€—ç”µ
- **ä¼˜åŒ–å»ºè®®**: 
  - å‡å°‘ä¸»çº¿ç¨‹è®¡ç®—
  - ä¼˜åŒ–ç®—æ³•å¤æ‚åº¦
  - ä½¿ç”¨å¼‚æ­¥å¤„ç†

## ğŸ§  å†…å­˜ç›‘æ§

### ç›‘æ§åŸç†

**Android**:
- PSS (Proportional Set Size): è¿›ç¨‹å®é™…ä½¿ç”¨çš„ç‰©ç†å†…å­˜
- Private Dirty: è¿›ç¨‹ç§æœ‰çš„è„é¡µå†…å­˜
- é€šè¿‡ `dumpsys meminfo` è·å–è¯¦ç»†å†…å­˜ä¿¡æ¯

**iOS**:
- ä½¿ç”¨ Instruments ç›¸å…³ API è·å–å†…å­˜æ•°æ®
- ç›‘æ§åº”ç”¨çš„å†…å­˜å ç”¨å’Œç³»ç»Ÿå¯ç”¨å†…å­˜

### æ•°æ®æ ¼å¼

```json
// åŸºç¡€å†…å­˜ä¿¡æ¯
{
  "pss": 156.8,      // PSS å†…å­˜ (MB)
  "private": 128.4,  // ç§æœ‰å†…å­˜ (MB)
  "total": 2048.0    // æ€»å†…å­˜ (MB)
}

// è¯¦ç»†å†…å­˜ä¿¡æ¯
{
  "java_heap": 45.2,     // Java å †å†…å­˜
  "native_heap": 23.1,   // Native å †å†…å­˜
  "code": 12.5,          // ä»£ç æ®µå†…å­˜
  "stack": 2.3,          // æ ˆå†…å­˜
  "graphics": 18.7,      // å›¾å½¢å†…å­˜
  "private_other": 15.4, // å…¶ä»–ç§æœ‰å†…å­˜
  "system": 8.9          // ç³»ç»Ÿå†…å­˜
}
```

### ä½¿ç”¨ç¤ºä¾‹

```python
# åŸºç¡€å†…å­˜ç›‘æ§
pss, private, total = apm.collectMemory()
print(f"PSS: {pss}MB, Private: {private}MB")

# è¯¦ç»†å†…å­˜ç›‘æ§
memory_detail = apm.collectMemoryDetail()
print(f"Java Heap: {memory_detail['java_heap']}MB")
```

### å†…å­˜æ³„æ¼æ£€æµ‹

```python
import time

# è¿ç»­ç›‘æ§å†…å­˜å˜åŒ–
memory_history = []
for i in range(60):  # ç›‘æ§ 1 åˆ†é’Ÿ
    pss, _, _ = apm.collectMemory()
    memory_history.append(pss)
    time.sleep(1)

# åˆ†æå†…å­˜è¶‹åŠ¿
if len(memory_history) > 10:
    recent_avg = sum(memory_history[-10:]) / 10
    early_avg = sum(memory_history[:10]) / 10
    growth_rate = (recent_avg - early_avg) / early_avg * 100
    
    if growth_rate > 20:  # å†…å­˜å¢é•¿è¶…è¿‡ 20%
        print(f"âš ï¸ å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œå¢é•¿ç‡: {growth_rate:.2f}%")
```

## ğŸŒ ç½‘ç»œç›‘æ§

### ç›‘æ§åŸç†

**Android**:
- é€šè¿‡ `/proc/net/dev` è·å–ç½‘ç»œæ¥å£æµé‡
- åŒºåˆ† WiFi å’Œç§»åŠ¨ç½‘ç»œæµé‡
- è®¡ç®—åº”ç”¨çš„ä¸Šè¡Œå’Œä¸‹è¡Œæµé‡

**iOS**:
- ä½¿ç”¨ç³»ç»Ÿ API è·å–ç½‘ç»œç»Ÿè®¡ä¿¡æ¯
- ç›‘æ§åº”ç”¨çº§åˆ«çš„ç½‘ç»œä½¿ç”¨æƒ…å†µ

### æ•°æ®æ ¼å¼

```json
{
  "upflow": 1024.5,    // ä¸Šè¡Œæµé‡ (KB)
  "downflow": 2048.3   // ä¸‹è¡Œæµé‡ (KB)
}
```

### ä½¿ç”¨ç¤ºä¾‹

```python
# ç½‘ç»œæµé‡ç›‘æ§
upflow, downflow = apm.collectNetwork(wifi=True)
print(f"ä¸Šè¡Œ: {upflow}KB, ä¸‹è¡Œ: {downflow}KB")

# ç½‘ç»œé€Ÿåº¦è®¡ç®—
import time

# ç¬¬ä¸€æ¬¡æµ‹é‡
up1, down1 = apm.collectNetwork()
time.sleep(1)
# ç¬¬äºŒæ¬¡æµ‹é‡
up2, down2 = apm.collectNetwork()

# è®¡ç®—é€Ÿåº¦ (KB/s)
upload_speed = up2 - up1
download_speed = down2 - down1
print(f"ä¸Šä¼ é€Ÿåº¦: {upload_speed}KB/s, ä¸‹è½½é€Ÿåº¦: {download_speed}KB/s")
```

## ğŸ® FPS ç›‘æ§

### ç›‘æ§åŸç†

**Android**:
- **SurfaceView æ¨¡å¼**: é€šè¿‡ `dumpsys SurfaceFlinger` è·å–å¸§ç‡
- **GfxInfo æ¨¡å¼**: é€šè¿‡ `dumpsys gfxinfo` è·å–æ¸²æŸ“ä¿¡æ¯
- è®¡ç®—å¡é¡¿å¸§æ•°å’Œä¸¢å¸§ç‡

**iOS**:
- ä½¿ç”¨ Core Animation ç›¸å…³ API
- ç›‘æ§ä¸»çº¿ç¨‹çš„æ¸²æŸ“æ€§èƒ½

### æ•°æ®æ ¼å¼

```json
{
  "fps": 60,    // å½“å‰å¸§ç‡ (Hz)
  "jank": 2     // å¡é¡¿æ¬¡æ•°
}
```

### ä½¿ç”¨ç¤ºä¾‹

```python
# FPS ç›‘æ§
fps, jank = apm.collectFps()
print(f"FPS: {fps}, å¡é¡¿: {jank}")

# æµç•…åº¦åˆ†æ
def analyze_smoothness(fps_values):
    avg_fps = sum(fps_values) / len(fps_values)
    low_fps_count = sum(1 for fps in fps_values if fps < 30)
    
    if avg_fps >= 55:
        return "æµç•…"
    elif avg_fps >= 45:
        return "ä¸€èˆ¬"
    else:
        return "å¡é¡¿"

# æ”¶é›† FPS æ•°æ®
fps_history = []
for _ in range(30):  # æ”¶é›† 30 ç§’æ•°æ®
    fps, _ = apm.collectFps()
    fps_history.append(fps)
    time.sleep(1)

smoothness = analyze_smoothness(fps_history)
print(f"åº”ç”¨æµç•…åº¦: {smoothness}")
```

## ğŸ”‹ ç”µæ± ç›‘æ§

### ç›‘æ§åŸç†

**Android**:
- é€šè¿‡ `dumpsys battery` è·å–ç”µæ± çŠ¶æ€
- ç›‘æ§ç”µé‡ã€æ¸©åº¦ã€ç”µæµã€ç”µå‹ç­‰ä¿¡æ¯
- è®¡ç®—åŠŸè€— (åŠŸç‡ = ç”µå‹ Ã— ç”µæµ)

**iOS**:
- ä½¿ç”¨ IOKit æ¡†æ¶è·å–ç”µæ± ä¿¡æ¯
- ç›‘æ§ç”µæ± å¥åº·çŠ¶æ€å’Œå……ç”µçŠ¶æ€

### æ•°æ®æ ¼å¼

```json
{
  "level": 85,        // ç”µé‡ç™¾åˆ†æ¯” (%)
  "temperature": 32.5, // æ¸©åº¦ (Â°C)
  "current": -150,    // ç”µæµ (mAï¼Œè´Ÿå€¼è¡¨ç¤ºæ”¾ç”µ)
  "voltage": 4200,    // ç”µå‹ (mV)
  "power": 0.63       // åŠŸè€— (W)
}
```

### ä½¿ç”¨ç¤ºä¾‹

```python
# ç”µæ± ç›‘æ§
battery_info = apm.collectBattery()
print(f"ç”µé‡: {battery_info['level']}%")
print(f"æ¸©åº¦: {battery_info['temperature']}Â°C")
print(f"åŠŸè€—: {battery_info['power']}W")

# ç”µæ± å¥åº·åˆ†æ
def analyze_battery_health(battery_data):
    level = battery_data['level']
    temperature = battery_data['temperature']
    power = battery_data['power']
    
    issues = []
    
    if level < 20:
        issues.append("ç”µé‡è¿‡ä½")
    if temperature > 40:
        issues.append("æ¸©åº¦è¿‡é«˜")
    if power > 2.0:
        issues.append("åŠŸè€—è¿‡å¤§")
    
    return issues if issues else ["ç”µæ± çŠ¶æ€æ­£å¸¸"]

health_issues = analyze_battery_health(battery_info)
print(f"ç”µæ± å¥åº·: {', '.join(health_issues)}")
```

## ğŸ¨ GPU ç›‘æ§ (ä»… Android)

### ç›‘æ§åŸç†

- é€šè¿‡ `dumpsys gpu` è·å– GPU ä½¿ç”¨ç‡
- ç›‘æ§ GPU æ¸²æŸ“è´Ÿè½½å’Œé¢‘ç‡
- åˆ†æå›¾å½¢æ€§èƒ½ç“¶é¢ˆ

### æ•°æ®æ ¼å¼

```json
{
  "gpu_usage": 45.2  // GPU ä½¿ç”¨ç‡ (%)
}
```

### ä½¿ç”¨ç¤ºä¾‹

```python
# GPU ç›‘æ§ (ä»… Android)
if platform == 'Android':
    gpu_usage = apm.collectGpu()
    print(f"GPU ä½¿ç”¨ç‡: {gpu_usage}%")
    
    if gpu_usage > 80:
        print("âš ï¸ GPU è´Ÿè½½è¿‡é«˜ï¼Œå¯èƒ½å½±å“æ¸²æŸ“æ€§èƒ½")
```

## ğŸ’¾ ç£ç›˜ I/O ç›‘æ§

### ç›‘æ§åŸç†

- ç›‘æ§åº”ç”¨çš„ç£ç›˜è¯»å†™æ“ä½œ
- åˆ†æ I/O æ€§èƒ½ç“¶é¢ˆ
- æ£€æµ‹é¢‘ç¹çš„æ–‡ä»¶æ“ä½œ

### ä½¿ç”¨ç¤ºä¾‹

```python
# ç£ç›˜ I/O ç›‘æ§
disk_io = apm.collectDisk()
print(f"ç£ç›˜ I/O: {disk_io}")
```

## ğŸŒ¡ï¸ æ¸©åº¦ç›‘æ§

### ç›‘æ§åŸç†

- ç›‘æ§è®¾å¤‡å„ä¸ªä¼ æ„Ÿå™¨çš„æ¸©åº¦
- åŒ…æ‹¬ CPUã€ç”µæ± ã€GPU ç­‰ç»„ä»¶æ¸©åº¦
- åˆ†æè®¾å¤‡çƒ­ç®¡ç†çŠ¶æ€

### ä½¿ç”¨ç¤ºä¾‹

```python
# æ¸©åº¦ç›‘æ§
thermal_data = apm.collectThermal()
print(f"è®¾å¤‡æ¸©åº¦: {thermal_data}")
```

## ğŸ“ˆ æ€§èƒ½åˆ†ææœ€ä½³å®è·µ

### 1. ç›‘æ§ç­–ç•¥

```python
# å…¨é¢æ€§èƒ½ç›‘æ§
def comprehensive_monitoring(apm, duration=300):
    """å…¨é¢æ€§èƒ½ç›‘æ§"""
    start_time = time.time()
    performance_data = {
        'cpu': [],
        'memory': [],
        'network': [],
        'fps': [],
        'battery': []
    }
    
    while time.time() - start_time < duration:
        # æ”¶é›†å„é¡¹æŒ‡æ ‡
        app_cpu, sys_cpu = apm.collectCpu()
        pss, private, total = apm.collectMemory()
        upflow, downflow = apm.collectNetwork()
        fps, jank = apm.collectFps()
        battery = apm.collectBattery()
        
        # è®°å½•æ•°æ®
        performance_data['cpu'].append({
            'timestamp': time.time(),
            'app_cpu': app_cpu,
            'sys_cpu': sys_cpu
        })
        
        performance_data['memory'].append({
            'timestamp': time.time(),
            'pss': pss,
            'private': private
        })
        
        # ... è®°å½•å…¶ä»–æ•°æ®
        
        time.sleep(1)  # 1ç§’é‡‡æ ·é—´éš”
    
    return performance_data
```

### 2. å¼‚å¸¸æ£€æµ‹

```python
def detect_performance_issues(performance_data):
    """æ€§èƒ½é—®é¢˜æ£€æµ‹"""
    issues = []
    
    # CPU å¼‚å¸¸æ£€æµ‹
    cpu_values = [d['app_cpu'] for d in performance_data['cpu']]
    avg_cpu = sum(cpu_values) / len(cpu_values)
    if avg_cpu > 50:
        issues.append(f"CPU ä½¿ç”¨ç‡è¿‡é«˜: {avg_cpu:.1f}%")
    
    # å†…å­˜å¼‚å¸¸æ£€æµ‹
    memory_values = [d['pss'] for d in performance_data['memory']]
    if len(memory_values) > 10:
        memory_growth = (memory_values[-1] - memory_values[0]) / memory_values[0] * 100
        if memory_growth > 30:
            issues.append(f"å†…å­˜å¢é•¿è¿‡å¿«: {memory_growth:.1f}%")
    
    # FPS å¼‚å¸¸æ£€æµ‹
    fps_values = [d['fps'] for d in performance_data['fps']]
    low_fps_ratio = sum(1 for fps in fps_values if fps < 30) / len(fps_values)
    if low_fps_ratio > 0.2:
        issues.append(f"ä½å¸§ç‡æ¯”ä¾‹è¿‡é«˜: {low_fps_ratio*100:.1f}%")
    
    return issues
```

### 3. æŠ¥å‘Šç”Ÿæˆ

```python
def generate_performance_report(performance_data, output_path):
    """ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š"""
    import json
    from datetime import datetime
    
    report = {
        'timestamp': datetime.now().isoformat(),
        'summary': {
            'duration': len(performance_data['cpu']),
            'avg_cpu': sum(d['app_cpu'] for d in performance_data['cpu']) / len(performance_data['cpu']),
            'max_memory': max(d['pss'] for d in performance_data['memory']),
            'avg_fps': sum(d['fps'] for d in performance_data['fps']) / len(performance_data['fps'])
        },
        'issues': detect_performance_issues(performance_data),
        'raw_data': performance_data
    }
    
    with open(output_path, 'w') as f:
        json.dump(report, f, indent=2)
    
    print(f"æ€§èƒ½æŠ¥å‘Šå·²ç”Ÿæˆ: {output_path}")
```

---

*ä¸‹ä¸€æ­¥: [éƒ¨ç½²æŒ‡å—](./07-éƒ¨ç½²æŒ‡å—.md)*
